<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="license" content="MIT License">
    <meta name="copyright" content="Copyright (c) 2026 BuildIT Design Labs, LLC">
    <!-- Content Security Policy to mitigate XSS attacks -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data:; font-src 'self' data: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; connect-src 'self';">
    <title>Mining Block Model Generator</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 data-i18n="app.title">Mining Block Model Generator</h1>
            <p data-i18n="app.subtitle">Create dummy 3D block models for testing mining applications</p>
            <div class="header-buttons">
                <div class="language-selector">
                    <button id="languageSelectBtn" class="header-btn language-btn" style="margin-right: 8px;">
                        <img id="languageFlag" src="images/Flag_of_the_United_Kingdom.svg" alt="Language" style="width: 24px; height: 18px; object-fit: cover; border: 1px solid rgba(255,255,255,0.2);">
                    </button>
                    <div id="languageDropdown" class="language-dropdown" style="display: none;">
                        <div class="language-option" data-locale="en">
                            <img src="images/Flag_of_the_United_Kingdom.svg" alt="English" style="width: 32px; height: 24px; object-fit: cover; border: 1px solid rgba(255,255,255,0.2);">
                        </div>
                        <div class="language-option" data-locale="es">
                            <img src="images/Flag_of_Spain.svg" alt="Español" style="width: 32px; height: 24px; object-fit: cover; border: 1px solid rgba(255,255,255,0.2);">
                        </div>
                        <div class="language-option" data-locale="fr">
                            <img src="images/Flag_of_France.svg" alt="Français" style="width: 32px; height: 24px; object-fit: cover; border: 1px solid rgba(255,255,255,0.2);">
                        </div>
                    </div>
                </div>
                <button id="statsBtn" class="header-btn" data-i18n="buttons.stats" title="Stats"><i class="fas fa-user"></i></button>
                <button id="galleryBtn" class="header-btn" data-i18n="buttons.gallery" title="Gallery"><i class="fas fa-images"></i></button>
                <button id="docsBtnControl" class="header-btn" data-i18n="buttons.documentation" title="Documentation"><i class="fas fa-question-circle"></i></button>
                <button id="aboutBtn" class="header-btn" data-i18n="buttons.about" title="About"><i class="fas fa-info-circle"></i></button>
            </div>
        </header>

        <div class="main-content">
            <aside class="control-panel">
                <div class="section-header">
                    <h2 data-i18n="modelParameters.title">Model Parameters</h2>
                </div>
                
                <form id="modelForm">
                    <div class="form-row">
                        <div class="form-group compact">
                            <label for="originX" data-i18n="modelParameters.originX">Origin X</label>
                            <input type="number" id="originX" value="0" step="0.1">
                        </div>
                        <div class="form-group compact">
                            <label for="originY" data-i18n="modelParameters.originY">Origin Y</label>
                            <input type="number" id="originY" value="0" step="0.1">
                        </div>
                        <div class="form-group compact">
                            <label for="originZ" data-i18n="modelParameters.originZ">Origin Z</label>
                            <input type="number" id="originZ" value="0" step="0.1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group compact">
                            <label for="cellSizeX" data-i18n="modelParameters.cellSizeX">Cell Size X</label>
                            <input type="number" id="cellSizeX" value="1" step="0.1" min="0.1">
                        </div>
                        <div class="form-group compact">
                            <label for="cellSizeY" data-i18n="modelParameters.cellSizeY">Cell Size Y</label>
                            <input type="number" id="cellSizeY" value="1" step="0.1" min="0.1">
                        </div>
                        <div class="form-group compact">
                            <label for="cellSizeZ" data-i18n="modelParameters.cellSizeZ">Cell Size Z</label>
                            <input type="number" id="cellSizeZ" value="1" step="0.1" min="0.1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group compact">
                            <label for="cellsX" data-i18n="modelParameters.cellsX">Cells X</label>
                            <input type="number" id="cellsX" value="25" step="1" min="1">
                        </div>
                        <div class="form-group compact">
                            <label for="cellsY" data-i18n="modelParameters.cellsY">Cells Y</label>
                            <input type="number" id="cellsY" value="25" step="1" min="1">
                        </div>
                        <div class="form-group compact">
                            <label for="cellsZ" data-i18n="modelParameters.cellsZ">Cells Z</label>
                            <input type="number" id="cellsZ" value="25" step="1" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="patternType" data-i18n="modelParameters.materialPattern">Material Pattern</label>
                        <select id="patternType">
                            <option value="porphyry_ore">Porphyry-Style Zoning</option>
                            <option value="vein_ore">Vein/Structural Ore Body</option>
                            <option value="ellipsoid_ore">Ellipsoid Ore Body</option>
                            <option value="salt_dome">Salt Dome Reservoir (Petroleum)</option>
                            <option value="random_clusters" selected>Random Clusters</option>
                            <option value="inclined_vein">Inclined Vein</option>
                            <option value="ore_horizon">Single Ore Horizon</option>
                            <option value="random">Random</option>
                            <option value="checkerboard">Checkerboard</option>
                            <option value="gradient">Gradient</option>
                            <option value="layered">Layered</option>
                            <option value="uniform">Uniform</option>
                        </select>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" id="generateBtn" data-i18n="buttons.generate" title="Generate"><i class="fas fa-play"></i></button>
                        <button type="button" id="zoomResetBtn" data-i18n="buttons.zoomToFit" title="Zoom to Fit"><i class="fas fa-search-plus"></i></button>
                        <button type="button" id="exportBtn" disabled data-i18n="buttons.export" title="Export"><i class="fas fa-download"></i></button>
                        <button type="button" id="saveModelBtn" disabled class="header-btn" data-i18n="gallery.saveCurrent" title="Save Model"><i class="fas fa-star"></i></button>
                        <button type="button" id="saveImageBtn" disabled data-i18n="buttons.saveImage" title="Save Image"><i class="fas fa-camera"></i></button>
                    </div>
                </form>
                
                <div class="collapsible-section">
                    <div class="section-header collapsible-header" onclick="toggleSection(this)">
                        <h3 data-i18n="visualization.title">Visualization</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <form id="vizForm">
                            <div class="form-row form-row-2col">
                                <div class="form-group compact">
                                    <label for="viewMode" data-i18n="visualization.viewMode">View Mode</label>
                                    <select id="viewMode">
                                        <option value="solid">Solid</option>
                                        <option value="points">Points</option>
                                        <option value="transparent">Transparent</option>
                                        <option value="squares">Squares</option>
                                        <option value="slicesX">Slices X</option>
                                        <option value="slicesY">Slices Y</option>
                                        <option value="slicesZ">Slices Z</option>
                                    </select>
                                </div>
                                <div class="form-group compact">
                                    <label for="visualizationField" data-i18n="visualization.field">Field</label>
                                    <select id="visualizationField">
                                        <option value="rockType">Rock Type</option>
                                        <option value="density">Density</option>
                                        <option value="gradeCu">Cu Grade</option>
                                        <option value="gradeAu">Au Grade</option>
                                        <option value="econValue">Value</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="section-header collapsible-header" onclick="toggleSection(this)">
                        <h3 data-i18n="sliceTool.title">Slice Tool</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <form id="sliceForm">
                            <div class="form-group compact">
                                <label>
                                    <input type="checkbox" id="sliceEnabled" style="width: auto; margin-right: 6px;">
                                    <span data-i18n="sliceTool.enable">Enable</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="sliceAxis" data-i18n="sliceTool.axis">Axis</label>
                                <select id="sliceAxis">
                                    <option value="x">X (Front/Back)</option>
                                    <option value="y">Y (Left/Right)</option>
                                    <option value="z" selected>Z (Up/Down)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="slicePosition">Position: <span id="slicePositionValue">0</span></label>
                                <input type="range" id="slicePosition" min="-500" max="500" value="0" step="1">
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="section-header collapsible-header" onclick="toggleSection(this)">
                        <h3 data-i18n="valueFilter.title">Value Filter</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <form id="valueVisibilityForm">
                            <div class="form-group compact">
                                <label>
                                    <input type="checkbox" id="valueVisibilityEnabled" style="width: auto; margin-right: 6px;">
                                    <span data-i18n="valueFilter.enable">Enable Filter</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="valueVisibilityMode" data-i18n="valueFilter.mode">Mode</label>
                                <select id="valueVisibilityMode">
                                    <option value="above">Above threshold</option>
                                    <option value="below">Below threshold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="valueVisibilityThreshold">Threshold: <span id="valueVisibilityThresholdValue">0</span></label>
                                <input type="range" id="valueVisibilityThreshold" min="0" max="1000" value="0" step="0.1">
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="section-header collapsible-header" onclick="toggleSection(this)">
                        <h3 data-i18n="categoryFilter.title">Category Filter</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <form id="categoryFilterForm">
                            <div class="form-group compact">
                                <label>
                                    <input type="checkbox" id="categoryFilterEnabled" style="width: auto; margin-right: 6px;">
                                    <span data-i18n="categoryFilter.enable">Enable Filter</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label data-i18n="categoryFilter.showHide">Show/Hide Categories:</label>
                                <div id="categoryFilterCheckboxes" style="max-height: 200px; overflow-y: auto; margin-top: 8px;">
                                    <p style="font-size: 0.85em; opacity: 0.7; margin: 8px 0;" data-i18n="categoryFilter.selectField">Select a categorical field (e.g., Rock Type) to filter</p>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="section-header collapsible-header" onclick="toggleSection(this)">
                        <h3 data-i18n="groundLayer.title">Ground Layer</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <form id="groundForm">
                            <div class="form-group compact">
                                <label>
                                    <input type="checkbox" id="groundEnabled" style="width: auto; margin-right: 6px;">
                                    <span data-i18n="groundLayer.showGround">Show Ground</span>
                                </label>
                            </div>
                        </form>
                    </div>
                </div>
                
            </aside>

            <main class="visualization-area">
                <div id="canvasContainer">
                    <div id="status" class="status-canvas-message" style="display: none;">
                        <span id="statusText"></span>
                        <button id="statusClose" class="status-close" title="Close">&times;</button>
                    </div>
                </div>
                <div id="blockTooltip" class="block-tooltip" style="display: none;"></div>
                <div class="controls-hint">
                    <p data-i18n="controls.hint">Controls: Left-click drag to rotate | Right-click drag to pan | Scroll to zoom</p>
                </div>
                <!-- Model Statistics Button (On-Canvas) -->
                <button id="modelStatsBtn" class="canvas-button" title="Model Statistics" style="display: none;">
                    <i class="fas fa-file-invoice"></i>
                </button>
            </main>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="about.title">About</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong data-i18n="about.appName">Mining Block Model Generator</strong></p>
                <p data-i18n="about.builtBy">Built by <strong><a href="mailto:chris@builditdesignlab.com">Chris Andrews</a></strong>, <a href="https://www.builditdesignlab.com/#block-model-generator" target="_blank" rel="noopener noreferrer">BuildIT Design Labs</a></p>
                <p style="margin-top: 20px;">
                    <strong data-i18n="about.license">License: <a href="https://opensource.org/license/mit" target="_blank" rel="noopener noreferrer">MIT License</a></strong><br>
                    <strong data-i18n="about.copyright" data-i18n-params='{"year": "2026"}'>Copyright: © 2026 All rights reserved</strong>
                </p>
                <div style="margin-top: 20px; text-align: center; display: flex; gap: 10px; justify-content: center; align-items: center;">
                    <button id="githubBtn" class="header-btn" title="View on GitHub" style="flex: 0 0 auto; width: auto;">
                        <i class="fas fa-code"></i>
                    </button>
                    <button id="memoryBtn" class="header-btn" data-i18n="buttons.memory" title="Memory" style="flex: 0 0 auto; width: auto;"><i class="fas fa-microchip"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Panel (Non-modal) -->
    <div id="statsPanel" class="memory-panel" style="display: none;">
        <div class="memory-panel-content">
            <div class="memory-panel-header">
                <h3 data-i18n="stats.title">Statistics Dashboard</h3>
                <span class="memory-panel-close">&times;</span>
            </div>
            <div class="memory-panel-body">
                <div id="statsContent" style="font-size: 0.9em; line-height: 1.6;">
                    <!-- Statistics will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Model Gallery Panel (Non-modal) -->
    <div id="galleryPanel" class="memory-panel" style="display: none;">
        <div class="memory-panel-content">
            <div class="memory-panel-header">
                <h3 data-i18n="gallery.title">Model Gallery</h3>
                <span class="memory-panel-close">&times;</span>
            </div>
            <div class="memory-panel-body">
                <div style="margin-bottom: 12px;">
                    <button id="saveCurrentModelBtn" class="header-btn" style="width: 100%;" data-i18n="gallery.saveCurrent"><i class="fas fa-star"></i> <span>Save Current Model</span></button>
                </div>
                <div id="galleryContent">
                    <!-- Gallery items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Save Model Dialog (Modal) -->
    <div id="saveModelModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 data-i18n="gallery.saveModel">Save Model</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modelNameInput" data-i18n="gallery.modelName">Model Name:</label>
                    <input type="text" id="modelNameInput" placeholder="Enter model name" style="width: 100%; padding: 8px; margin-top: 8px;">
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <button id="saveModelConfirmBtn" class="header-btn" data-i18n="buttons.save"><i class="fas fa-star"></i> <span>Save</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Statistics Modal -->
    <div id="modelStatsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 data-i18n="modelStats.title">Model Statistics</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modelStatsContent" style="font-size: 0.9em; line-height: 1.6;">
                    <!-- Statistics will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Memory Monitor Panel (Non-modal) -->
    <div id="memoryPanel" class="memory-panel" style="display: none;">
        <div class="memory-panel-content">
            <div class="memory-panel-header">
                <h3 data-i18n="memory.title">Memory Monitor</h3>
                <span class="memory-panel-close">&times;</span>
            </div>
            <div class="memory-panel-body">
                <div id="memoryInfo" style="font-family: monospace; font-size: 0.9em;">
                    <p><strong data-i18n="memory.usage">Memory Usage:</strong></p>
                    <p id="memoryDetails" data-i18n="memory.loading">Loading...</p>
                    <p style="margin-top: 15px; font-size: 0.85em; opacity: 0.8;">
                        <em data-i18n="memory.note">Note: Memory information may not be available in all browsers.</em>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- External CDN scripts with Subresource Integrity (SRI) for security -->
    <!-- TODO: Add integrity hashes - visit CDN pages or use: openssl dgst -sha384 -binary <file> | openssl base64 -A -->
    <!-- Three.js r128: https://cdnjs.com/libraries/three.js/r128 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" 
            integrity="" 
            crossorigin="anonymous"></script>
    <!-- OrbitControls: https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"
            integrity=""
            crossorigin="anonymous"></script>
    <!-- JSZip 3.10.1: https://cdnjs.com/libraries/jszip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
            integrity=""
            crossorigin="anonymous"></script>
    <script src="scripts/i18n.js"></script>
    <script>
        // Toggle collapsible sections
        function toggleSection(header) {
            const section = header.parentElement;
            const content = section.querySelector('.collapsible-content');
            const icon = header.querySelector('.toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
            }
        }
        
        // Initialize collapsible sections (collapsed by default except first)
        document.addEventListener('DOMContentLoaded', function() {
            const sections = document.querySelectorAll('.collapsible-section');
            sections.forEach((section, index) => {
                const content = section.querySelector('.collapsible-content');
                const icon = section.querySelector('.toggle-icon');
                if (index > 0) {
                    content.style.display = 'none';
                    icon.textContent = '▶';
                }
            });
            
            // Modals are initialized in main.js
            
            // Initialize language selector (wait for i18n to be ready)
            let languageSelectorInitialized = false;
            let localeChangeHandler = null;
            
            function initLanguageSelector() {
                if (languageSelectorInitialized) return;
                
                const languageSelectBtn = document.getElementById('languageSelectBtn');
                const languageDropdown = document.getElementById('languageDropdown');
                const languageFlag = document.getElementById('languageFlag');
                const languageOptions = document.querySelectorAll('.language-option');
                
                if (!languageSelectBtn || !languageDropdown || !languageFlag) {
                    // Retry if elements aren't ready
                    setTimeout(initLanguageSelector, 50);
                    return;
                }
                
                languageSelectorInitialized = true;
                
                // Update flag based on current locale
                function updateLanguageDisplay(locale) {
                    const flagMap = {
                        'en': 'images/Flag_of_the_United_Kingdom.svg',
                        'es': 'images/Flag_of_Spain.svg',
                        'fr': 'images/Flag_of_France.svg'
                    };
                    
                    if (languageFlag && flagMap[locale]) {
                        languageFlag.src = flagMap[locale];
                    }
                }
                
                // Create a stable handler function that captures the flag element
                if (!window.languageFlagUpdateHandler) {
                    window.languageFlagUpdateHandler = function(e) {
                        const flagElement = document.getElementById('languageFlag');
                        if (!flagElement) return;
                        
                        const locale = (e && e.detail && e.detail.locale) 
                            ? e.detail.locale 
                            : (typeof getLocale === 'function' ? getLocale() : 'en');
                        
                        const flagMap = {
                            'en': 'images/Flag_of_the_United_Kingdom.svg',
                            'es': 'images/Flag_of_Spain.svg',
                            'fr': 'images/Flag_of_France.svg'
                        };
                        
                        if (flagMap[locale]) {
                            flagElement.src = flagMap[locale];
                        }
                    };
                }
                
                // Toggle dropdown
                languageSelectBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isVisible = languageDropdown.style.display !== 'none' && languageDropdown.style.display !== '';
                    languageDropdown.style.display = isVisible ? 'none' : 'flex';
                });
                
                // Close dropdown when clicking outside
                function closeDropdown(e) {
                    if (languageDropdown && !languageSelectBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
                        languageDropdown.style.display = 'none';
                    }
                }
                document.addEventListener('click', closeDropdown);
                
                // Handle language option clicks
                languageOptions.forEach(option => {
                    option.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const locale = option.getAttribute('data-locale');
                        if (locale) {
                            // Check if it's different from current locale
                            const currentLocale = typeof getLocale === 'function' ? getLocale() : 'en';
                            if (locale !== currentLocale) {
                                // Close dropdown immediately for better UX
                                languageDropdown.style.display = 'none';
                                
                                if (typeof setLocale === 'function') {
                                    try {
                                        // Update flag immediately (optimistic update)
                                        updateLanguageDisplay(locale);
                                        // Then set locale (which will trigger localeChanged event)
                                        await setLocale(locale);
                                    } catch (error) {
                                        console.error('Error setting locale:', error);
                                        // Revert on error
                                        if (typeof getLocale === 'function') {
                                            updateLanguageDisplay(getLocale());
                                        }
                                    }
                                } else {
                                    console.warn('setLocale function not available yet');
                                }
                            } else {
                                // Same locale selected, just close dropdown
                                languageDropdown.style.display = 'none';
                            }
                        }
                    });
                });
                
                // Listen for locale changes using the stable handler
                window.removeEventListener('localeChanged', window.languageFlagUpdateHandler);
                window.addEventListener('localeChanged', window.languageFlagUpdateHandler);
                
                // Initial update - trigger the handler manually to set initial flag
                function doInitialUpdate() {
                    if (typeof getLocale === 'function') {
                        const currentLocale = getLocale();
                        // Manually trigger the handler with the current locale
                        if (window.languageFlagUpdateHandler) {
                            window.languageFlagUpdateHandler({ detail: { locale: currentLocale } });
                        } else {
                            // Fallback to direct update
                            updateLanguageDisplay(currentLocale);
                        }
                    } else {
                        // Wait a bit more for i18n
                        setTimeout(doInitialUpdate, 100);
                    }
                }
                
                // Try initial update
                doInitialUpdate();
            }
            
            // Initialize language selector when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(initLanguageSelector, 100);
                });
            } else {
                setTimeout(initLanguageSelector, 100);
            }
        });
    </script>
    <script src="scripts/blockModel.js"></script>
    <script src="scripts/visualization.js"></script>
    <script src="scripts/main.js"></script>
</body>
</html>
